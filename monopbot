#!/usr/bin/python

import gobject, gtk, pango
from monop import Client as MonopClient

class MonopDisplay(gtk.VBox):
	def __init__(self):
		gtk.VBox.__init__(self)
		self.text = gtk.TextView()
		self.buttonbar = gtk.HBox()
		self.pack_start(self.text, True, True)
		self.pack_start(self.buttonbar, False, False)

		self.text.set_editable(False)
		self.text.set_cursor_visible(False)
		self.text.set_wrap_mode(gtk.WRAP_WORD)
		self.text.set_cursor_visible(False)
		buf = self.text.get_buffer()
		i = buf.get_iter_at_offset(0)
		self.end = buf.create_mark(None, i, left_gravity = False)

	def display(self, text = '', cleartext = False,
			clearbuttons = False, estateid = -1):
		buf = self.text.get_buffer()

		if cleartext:
			buf.set_text('')
			i = buf.get_iter_at_offset(0)
			buf.move_mark(self.end, i)

		i = buf.get_iter_at_offset(buf.get_char_count())
		buf.insert(i, text + '\n')

		i = buf.get_iter_at_offset(buf.get_char_count())
		buf.move_mark(self.end, i)
		self.text.scroll_mark_onscreen(self.end)
		buf.place_cursor(i)

class BotLog(gtk.TextView):
	def __setup_tags(self, buf):
		tag = buf.create_tag('font')
		tag.set_property('font', 'Lucida Console 8')

		tag = buf.create_tag('bold')
		tag.set_property('weight', pango.WEIGHT_BOLD)

		for x in ['red', 'blue', 'green',
				'cyan', 'magenta', 'yellow',
				'purple', 'black',
				'dark blue', 'dark green']:
			tag = buf.create_tag(x)
			tag.set_property('foreground', x)
			tag.set_property('foreground-set', True)

	def __init__(self):
		gtk.TextView.__init__(self)
		#self.set_border_window_size(gtk.TEXT_WINDOW_LEFT, 8)
		self.set_editable(False)
		self.set_cursor_visible(False)
		self.set_wrap_mode(gtk.WRAP_WORD)
		self.__setup_tags(self.get_buffer())

		buf = self.get_buffer()
		i = buf.get_iter_at_offset(0)
		self.end = buf.create_mark(None, i, left_gravity = False)


	def msg(self, msg, tags = []):
		from sys import stdout

		tags.append('font')
		buf = self.get_buffer()
		i = buf.get_iter_at_offset(buf.get_char_count())
		buf.insert_with_tags_by_name(i, msg, *tags)

		i = buf.get_iter_at_offset(buf.get_char_count())
		buf.move_mark(self.end, i)
		self.scroll_mark_onscreen(self.end)
		buf.place_cursor(i)

		stdout.write(msg)

class MainWin(gtk.Window):
	def destroy(self, *_):
		if self.client is not None:
			self.client.quit()
		gtk.Window.destroy(self)
		if self.in_main:
			gtk.mainquit()
			self.in_main = False

	def main(self):
		self.in_main = True
		gtk.main()

	def enter(self, entry):
		s = entry.get_text()
		entry.set_text('')
		if len(s):
			self.client.cmd(s)

	def __init__(self):
		gtk.Window.__init__(self, gtk.WINDOW_TOPLEVEL)
		self.client = None
		self.in_main = False
		self.connect('destroy', self.destroy)
		self.set_default_size(640, 480)
		self.set_title('monopbot')

		agr = gtk.AccelGroup()
		(k, m) = gtk.accelerator_parse('<Control>Q')
		agr.connect_group(k, m, gtk.ACCEL_VISIBLE, self.destroy)
		(k, m) = gtk.accelerator_parse('<Control>W')
		agr.connect_group(k, m, gtk.ACCEL_VISIBLE, self.destroy)
		self.add_accel_group(agr)

		scr = gtk.ScrolledWindow()
		scr.set_policy(gtk.POLICY_NEVER, gtk.POLICY_AUTOMATIC)
		self.log = BotLog()
		scr.add(self.log)

		entry = gtk.Entry()
		entry.connect('activate', self.enter)

		vb = gtk.VBox()
		vb.pack_start(scr, True, True)
		vb.pack_start(entry, False, False)

		self.disp = MonopDisplay()
		hb = gtk.HPaned()
		hb.add1(vb)
		hb.add2(self.disp)

		self.add(hb)
		self.show_all()

		self.client = MonopClient(self.log.msg, self.disp.display)
		self.client.connect_to('localhost', 11234)

if __name__ == '__main__':
	x = MainWin()
	x.main()
